const translations = {
    en: {
        title: "PDF to Audio Converter",
        subtitle: "Transform your documents into speech instantly.",
        langLabel: "Select Language",
        dragDrop: "Drag & Drop your PDF here",
        or: "or",
        browse: "Browse Files",
        uploadBtn: "Upload & Convert",
        uploadBtn: "Upload & Convert",
        uploading: "Converting...",
        success: "Success! Listen to your audio below.",
        errorArg: "An error occurred.",
        fileSelected: "File selected:",
        invalidFile: "Invalid file type. Please upload a PDF.",
        fileSelected: "File selected:",
        invalidFile: "Invalid file type. Please upload a PDF.",
        noFile: "No file selected.",
        translateLabel: "Translate content to this language?"
    },
    hi: {
        title: "पीडीएफ से ऑडियो कन्वर्टर",
        subtitle: "अपने दस्तावेज़ों को तुरंत वाणी में बदलें।",
        langLabel: "भाषा चुनें",
        dragDrop: "अपनी पीडीएफ यहाँ खींचें और छोड़ें",
        or: "या",
        browse: "फ़ाइलें ब्राउज़ करें",
        uploadBtn: "अपलोड और कन्वर्ट करें",
        uploading: "अपलोड हो रहा है...",
        success: "फ़ाइल सफलतापूर्वक अपलोड हो गई। ऑडियो रूपांतरण शीघ्र ही शुरू होगा।",
        errorArg: "एक त्रुटि हुई।",
        fileSelected: "चयनित फ़ाइल:",
        invalidFile: "अमान्य फ़ाइल प्रकार। कृपया पीडीएफ अपलोड करें।",
        invalidFile: "अमान्य फ़ाइल प्रकार। कृपया पीडीएफ अपलोड करें।",
        noFile: "कोई फ़ाइल चुनी नहीं गई।",
        translateLabel: "सामग्री का लेाषा में अनुवाद करें?"
    },
    es: {
        title: "Convertidor de PDF a Audio",
        subtitle: "Transforma tus documentos en voz al instante.",
        langLabel: "Seleccionar idioma",
        dragDrop: "Arrastra y suelta tu PDF aquí",
        or: "o",
        browse: "Examinar archivos",
        uploadBtn: "Cargar y Convertir",
        uploading: "Subiendo...",
        success: "Archivo subido con éxito. La conversión de audio comenzará en breve.",
        errorArg: "Ocurrió un error.",
        fileSelected: "Archivo seleccionado:",
        invalidFile: "Tipo de archivo no válido. Por favor, suba un PDF.",
        invalidFile: "Tipo de archivo no válido. Por favor, suba un PDF.",
        noFile: "No se seleccionó ningún archivo.",
        translateLabel: "¿Traducir contenido a este idioma?"
    },
    fr: {
        title: "Convertisseur PDF en Audio",
        subtitle: "Transformez vos documents en parole instantanément.",
        langLabel: "Choisir la langue",
        dragDrop: "Glissez-déposez votre PDF ici",
        or: "ou",
        browse: "Parcourir les fichiers",
        uploadBtn: "Télécharger et Convertir",
        uploading: "Téléchargement...",
        success: "Fichier téléchargé avec succès. La conversion audio commencera sous peu.",
        errorArg: "Une erreur s'est produite.",
        fileSelected: "Fichier sélectionné :",
        invalidFile: "Type de fichier invalide. Veuillez télécharger un PDF.",
        invalidFile: "Type de fichier invalide. Veuillez télécharger un PDF.",
        noFile: "Aucun fichier sélectionné.",
        translateLabel: "Traduire le contenu dans cette langue ?"
    },
    de: {
        title: "PDF in Audio Konverter",
        subtitle: "Verwandeln Sie Ihre Dokumente sofort in Sprache.",
        langLabel: "Sprache wählen",
        dragDrop: "PDF hierher ziehen und ablegen",
        or: "oder",
        browse: "Dateien durchsuchen",
        uploadBtn: "Hochladen & Konvertieren",
        uploading: "Hochladen...",
        success: "Datei erfolgreich hochgeladen. Die Audiokonvertierung beginnt in Kürze.",
        errorArg: "Ein Fehler ist aufgetreten.",
        fileSelected: "Ausgewählte Datei:",
        invalidFile: "Ungültiger Dateityp. Bitte laden Sie eine PDF hoch.",
        invalidFile: "Ungültiger Dateityp. Bitte laden Sie eine PDF hoch.",
        noFile: "Keine Datei ausgewählt.",
        translateLabel: "Inhalt in diese Sprache übersetzen?"
    },
    kn: {
        title: "PDF ನಿಂದ ಆಡಿಯೋ ಪರಿವರ್ತಕ",
        subtitle: "ನಿಮ್ಮ ದಾಖಲೆಗಳನ್ನು ತಕ್ಷಣವೇ ಧ್ವನಿಗೆ ಪರಿವರ್ತಿಸಿ.",
        langLabel: "ಭಾಷೆಯನ್ನು ಆಯ್ಕೆಮಾಡಿ",
        dragDrop: "ನಿಮ್ಮ PDF ಅನ್ನು ಇಲ್ಲಿ ಡ್ರ್ಯಾಗ್ ಮಾಡಿ",
        or: "ಅಥವಾ",
        browse: "ಫೈಲ್‌ಗಳನ್ನು ಇದರಲ್ಲಿ ಹುಡುಕಿ",
        uploadBtn: "ಅಪ್‌ಲೋಡ್ ಮಾಡಿ & ಪರಿವರ್ತಿಸಿ",
        uploading: "ಅಪ್‌ಲೋಡ್ ಆಗುತ್ತಿದೆ...",
        success: "ಫೈಲ್ ಯಶಸ್ವಿಯಾಗಿ ಅಪ್‌ಲೋಡ್ ಆಗಿದೆ. ಆಡಿಯೋ ಪರಿವರ್ತನೆ ಶೀಘ್ರದಲ್ಲೇ ಪ್ರಾರಂಭವಾಗಲಿದೆ.",
        errorArg: "ದೋಷ ಸಂಭವಿಸಿದೆ.",
        fileSelected: "ಆಯ್ಕೆಮಾಡಿದ ಫೈಲ್:",
        invalidFile: "ಅಮಾನ್ಯ ಫೈಲ್ ಪ್ರಕಾರ. ದಯವಿಟ್ಟು PDF ಅನ್ನು ಅಪ್‌ಲೋಡ್ ಮಾಡಿ.",
        noFile: "ಯಾವುದೇ ಫೈಲ್ ಆಯ್ಕೆ ಮಾಡಿಲ್ಲ。",
        translateLabel: "ವಿಷಯವನ್ನು ಈ ಭಾಷೆಗೆ ಅನುವಾದಿಸುವುದೇ?"
    }
};

document.addEventListener('DOMContentLoaded', () => {
    const langSelect = document.getElementById('language-select');
    const uploadForm = document.getElementById('upload-form');
    const fileInput = document.getElementById('file-input');
    const browseBtn = document.getElementById('browse-btn');
    const dropZone = document.getElementById('drop-zone');
    const fileNameDisplay = document.getElementById('file-name');
    const submitBtn = document.getElementById('convert-btn');
    const btnText = document.getElementById('btn-text');
    const loader = document.querySelector('.loader');
    const statusMessage = document.getElementById('status-message');
    const statusText = statusMessage.querySelector('.status-text');
    const statusIcon = statusMessage.querySelector('.status-icon');
    const audioContainer = document.getElementById('audio-container');
    const audioPlayer = document.getElementById('audio-player');
    const downloadLink = document.getElementById('download-link');

    let currentLang = 'en';

    // Language Change Handler
    langSelect.addEventListener('change', (e) => {
        currentLang = e.target.value;
        updateUIText();

        // Auto-check translation if language is not English (User request convenience)
        const translateCheck = document.getElementById('translate-check');
        if (translateCheck) {
            if (currentLang !== 'en') {
                translateCheck.checked = true;
            } else {
                translateCheck.checked = false;
            }
        }
    });

    function updateUIText() {
        const t = translations[currentLang];
        document.getElementById('app-title').textContent = t.title;
        document.getElementById('app-subtitle').textContent = t.subtitle;
        document.getElementById('lang-label').textContent = t.langLabel;
        document.getElementById('drag-drop-text').textContent = t.dragDrop;
        document.getElementById('or-text').textContent = t.or;
        document.getElementById('browse-btn').textContent = t.browse;

        const translateLabel = document.getElementById('translate-label');
        if (translateLabel) translateLabel.textContent = t.translateLabel;

        // Only update button text if not currently loading
        if (loader.classList.contains('hidden')) {
            btnText.textContent = t.uploadBtn;
        }
    }

    // File Selection Handlers
    browseBtn.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });

    // Drag and Drop Handlers
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropZone.classList.add('dragover');
    }

    function unhighlight(e) {
        dropZone.classList.remove('dragover');
    }

    dropZone.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        fileInput.files = files; // Sync with input
        handleFiles(files);
    });

    function handleFiles(files) {
        const t = translations[currentLang];
        if (files.length > 0) {
            const file = files[0];
            if (file.type === 'application/pdf') {
                fileNameDisplay.textContent = `${t.fileSelected} ${file.name}`;
                fileNameDisplay.style.color = 'var(--primary-color)';
                submitBtn.disabled = false;
                hideStatus();
            } else {
                fileNameDisplay.textContent = t.invalidFile;
                fileNameDisplay.style.color = '#dc2626';
                submitBtn.disabled = true;
                fileInput.value = ''; // Clear invalid file
            }
        }
    }

    // Form Submission
    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const t = translations[currentLang];
        const file = fileInput.files[0];

        if (!file) {
            showStatus(t.noFile, 'error');
            return;
        }

        // Show loading state
        btnText.textContent = t.uploading;
        loader.classList.remove('hidden');
        submitBtn.disabled = true;
        hideStatus();

        // Reset Audio Player
        if (audioContainer) {
            audioContainer.classList.add('hidden');
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('language', currentLang);
        formData.append('accent', document.getElementById('accent-select').value);
        formData.append('translate', document.getElementById('translate-check').checked);

        try {
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (response.ok) {
                // Determine success message based on returned language or current selected
                // Ideally, backend confirms, but we use frontend translation for now
                showStatus(t.success, 'success');

                // Show Audio Player with Custom UI
                if (result.audio_url && audioContainer) {
                    const audioFilename = result.audio_url + "?t=" + new Date().getTime();
                    audioPlayer.src = audioFilename;
                    audioPlayer.load();

                    // Update download link
                    downloadLink.href = result.audio_url;
                    downloadLink.setAttribute('download', result.filename.replace('.pdf', '.mp3'));

                    audioContainer.classList.remove('hidden');

                    // Reset custom player UI
                    const playBtn = document.getElementById('custom-play-btn');
                    const progress = document.getElementById('audio-progress');
                    const timeDisplay = document.getElementById('time-display');
                    const playIcon = playBtn.querySelector('i');

                    playIcon.className = 'fas fa-play';

                    const seekSlider = document.getElementById('seek-slider');
                    if (seekSlider) {
                        seekSlider.value = 0;
                        seekSlider.style.background = `linear-gradient(to right, #ec4899 0%, #e2e8f0 0%)`;
                    }

                    timeDisplay.textContent = '0:00 / 0:00';

                    // Try to play automatically
                    if (window.attemptAutoplay) {
                        window.attemptAutoplay();
                    }
                }
            } else {
                showStatus(result.message || t.errorArg, 'error');
            }
        } catch (error) {
            showStatus(t.errorArg, 'error');
            console.error('Error:', error);
        } finally {
            // Reset button state
            btnText.textContent = t.uploadBtn;
            loader.classList.add('hidden');
            submitBtn.disabled = false;
        }
    });

    function showStatus(message, type) {
        statusText.textContent = message;
        statusMessage.className = `status-area ${type}`; // remove hidden, add type

        if (type === 'success') {
            statusIcon.className = 'status-icon fas fa-check-circle';
        } else {
            statusIcon.className = 'status-icon fas fa-exclamation-circle';
        }
    }

    function hideStatus() {
        statusMessage.classList.add('hidden');
    }

    // --- Custom Audio Player Logic ---
    const customPlayBtn = document.getElementById('custom-play-btn');
    const rewindBtn = document.getElementById('rewind-btn');
    const forwardBtn = document.getElementById('forward-btn');
    // const audioTrack = document.getElementById('audio-track'); // Removed
    // const audioProgress = document.getElementById('audio-progress'); // Removed
    const localTimeDisplay = document.getElementById('time-display');
    const speedSelect = document.getElementById('speed-select');

    // Toggle Play/Pause
    if (customPlayBtn) {
        customPlayBtn.addEventListener('click', togglePlay);
    }

    // Rewind 10s
    if (rewindBtn) {
        rewindBtn.addEventListener('click', () => {
            audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 10);
        });
    }

    // Forward 10s
    if (forwardBtn) {
        forwardBtn.addEventListener('click', () => {
            audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 10);
        });
    }

    function togglePlay() {
        if (audioPlayer.paused) {
            audioPlayer.play().then(() => {
                // Playback started successfully
            }).catch(error => {
                console.error("Playback failed:", error);
                alert("Could not play audio. Please check your speaker settings or try a different browser.");
            });
        } else {
            audioPlayer.pause();
        }
    }

    // Play/Pause Icon Updates
    audioPlayer.addEventListener('play', () => {
        const icon = customPlayBtn.querySelector('i');
        icon.className = 'fas fa-pause';
    });

    audioPlayer.addEventListener('pause', () => {
        const icon = customPlayBtn.querySelector('i');
        icon.className = 'fas fa-play';
    });

    audioPlayer.addEventListener('ended', () => {
        const icon = customPlayBtn.querySelector('i');
        icon.className = 'fas fa-play';
        const seekSlider = document.getElementById('seek-slider');
        if (seekSlider) {
            seekSlider.value = 0;
            seekSlider.style.background = `linear-gradient(to right, #ec4899 0%, #e2e8f0 0%)`;
        }
    });

    // Seek Functionality (Dragging)
    const seekSlider = document.getElementById('seek-slider');

    // Update slider as audio plays
    audioPlayer.addEventListener('timeupdate', () => {
        const { currentTime, duration } = audioPlayer;
        if (!isNaN(duration) && duration > 0) {
            // Only update slider value if user is NOT currently dragging it
            // We can check document.activeElement, but simple approach is usually fine for timeupdate
            // To be smoother, we rely on interactions.
            seekSlider.value = (currentTime / duration) * 100;
            localTimeDisplay.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;

            // Optional: Update background gradient of slider to look like progress bar
            const val = seekSlider.value;
            seekSlider.style.background = `linear-gradient(to right, #ec4899 ${val}%, #e2e8f0 ${val}%)`;
        }
    });

    // When user drags slider
    if (seekSlider) {
        seekSlider.addEventListener('input', () => {
            // Real-time seeking (optional, or just update UI)
            const duration = audioPlayer.duration;
            if (!isNaN(duration)) {
                const seekTime = (seekSlider.value / 100) * duration;
                localTimeDisplay.textContent = `${formatTime(seekTime)} / ${formatTime(duration)}`;
                // Update gradient
                const val = seekSlider.value;
                seekSlider.style.background = `linear-gradient(to right, #ec4899 ${val}%, #e2e8f0 ${val}%)`;
            }
        });

        seekSlider.addEventListener('change', () => {
            // Committed seek (mouseup)
            const duration = audioPlayer.duration;
            if (!isNaN(duration)) {
                audioPlayer.currentTime = (seekSlider.value / 100) * duration;
            }
        });
    }

    // Speed Control
    if (speedSelect) {
        speedSelect.addEventListener('change', (e) => {
            audioPlayer.playbackRate = parseFloat(e.target.value);
        });
    }

    function formatTime(seconds) {
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${min}:${sec < 10 ? '0' : ''}${sec}`;
    }

    // Attempt Autoplay on File Load (Called from upload success)
    window.attemptAutoplay = function () {
        // Short delay to ensure DOM update
        setTimeout(() => {
            const playPromise = audioPlayer.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log("Autoplay prevented by browser:", error);
                    // No alert needed, user can click play manually
                });
            }
        }, 500);
    };
});
